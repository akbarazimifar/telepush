# Accepts, transforms and forwards events sent by [Bitbucket](https://bitbucket.org/) to a Telegram chat.
# Requires the `X-Event-Key` header to be set.
# Body payload: https://confluence.atlassian.com/bitbucket/event-payloads-740262817.html
# For details, see https://github.com/muety/telepush/blob/master/inlets/README.md.

name: bitbucket
content_type: application/json
header_vars:
  event_key: X-Event-Key
template: |
  {{ if or (eq .Vars.event_key "repo:commit_status_created") (eq .Vars.event_key "repo:commit_status_updated") }}
  {{ $emoji := "" }}
  {{ if eq .Message.commit_status.state "INPROGRESS" }}
  {{ $emoji = "⌛️" }}
  {{ else if eq .Message.commit_status.state "SUCCESSFUL" }}
  {{ $emoji = "✅" }}
  {{ else if eq .Message.commit_status.state "FAILED" }}
  {{ $emoji = "❌" }}
  {{ end }}
  {{ $emoji }} *{{ escapemd .Message.repository.name }}*: [{{ .Message.commit_status.state }}]({{ .Message.commit_status.url }})
  {{ escapemd .Message.commit_status.name }}
  {{ else }}
  Event {{ .Vars.event_key }} triggered.
  {{ end }}